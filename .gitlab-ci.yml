stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_FULL_NAME: "$DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$CI_COMMIT_SHORT_SHA"
  # í˜¸ìŠ¤íŠ¸ì˜ ë„ì»¤ ì†Œì¼“ì„ ì‚¬ìš©í•˜ë„ë¡ ê°•ì œ
  DOCKER_HOST: ""       
  DOCKER_TLS_CERTDIR: ""

.ai-dev-rules:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "ai-dev"'
    - if: '$CI_COMMIT_BRANCH == "ai-dev"'

build_push_dockerhub:
  stage: build
  # [ìˆ˜ì • 1] ìµœì‹  Docker í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë²„ì „ ì˜¤ë¥˜ í•´ê²°
  image: docker:latest 
  
  # [ìˆ˜ì • 2] services ì„¹ì…˜ ì‚­ì œ! (í˜¸ìŠ¤íŠ¸ ë„ì»¤ë¥¼ ì“°ë¯€ë¡œ dind ì„œë¹„ìŠ¤ëŠ” í•„ìš” ì—†ìŒ)
  # services:
  #   - docker:24.0.5-dind
  
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - echo "ğŸ“‚ ProjecTree-Inference í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤."
    - cd ProjecTree-Inference
    - echo "ğŸ³ Docker Hub ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
    - docker build -t $DOCKER_IMAGE_FULL_NAME .
    - docker push $DOCKER_IMAGE_FULL_NAME
  extends: .ai-dev-rules

deploy_to_aws:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$AWS_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $AWS_IP >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ AWS ì„œë²„ì— ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
    - ssh $AWS_USER@$AWS_IP "echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin"
    - ssh $AWS_USER@$AWS_IP "docker pull $DOCKER_IMAGE_FULL_NAME"
    - ssh $AWS_USER@$AWS_IP "docker stop inference-app || true"
    - ssh $AWS_USER@$AWS_IP "docker rm inference-app || true"
    - ssh $AWS_USER@$AWS_IP "docker run -d --name inference-app --env-file ./ai.env -p 8000:8000 $DOCKER_IMAGE_FULL_NAME"
    - ssh $AWS_USER@$AWS_IP "docker image prune -f"
  extends: .ai-dev-rules
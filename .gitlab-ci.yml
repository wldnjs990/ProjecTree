stages:
  - build
  - deploy

variables:
  # Docker Hub ì´ë¯¸ì§€ ê²½ë¡œ í˜•ì‹: ì•„ì´ë””/ë¦¬í¬ì§€í† ë¦¬:íƒœê·¸
  DOCKER_IMAGE_FULL_NAME: "$DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$CI_COMMIT_SHORT_SHA"

# ì‹¤í–‰ ì¡°ê±´ (ai-dev ë¸Œëœì¹˜ & MR)
.ai-dev-rules:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "ai-dev"'
    - if: '$CI_COMMIT_BRANCH == "ai-dev"'

# [Job 1] Docker Hubì— ë¹Œë“œ ë° Push
build_push_dockerhub:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    # Docker Hub ë¡œê·¸ì¸
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - echo "ğŸ“‚ projectree-inference í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤."
    - cd projectree-inference
    - echo "ğŸ³ Docker Hub ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤: $DOCKER_IMAGE_FULL_NAME"
    - docker build -t $DOCKER_IMAGE_FULL_NAME .
    - docker push $DOCKER_IMAGE_FULL_NAME
  extends: .ai-dev-rules

# [Job 2] AWS ë°°í¬
deploy_to_aws:
  stage: deploy
  image: alpine:latest
  before_script:
    # SSH ì ‘ì† ì¤€ë¹„
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$AWS_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $AWS_IP >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ AWS ì„œë²„ì— ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
    # 1. AWS ì„œë²„ì—ì„œ Docker Hub ë¡œê·¸ì¸ (Private Repoì¼ ê²½ìš° í•„ìˆ˜)
    - ssh $AWS_USER@$AWS_IP "echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin"
    
    # 2. ìµœì‹  ì´ë¯¸ì§€ Pull
    - ssh $AWS_USER@$AWS_IP "docker pull $DOCKER_IMAGE_FULL_NAME"
    
    # 3. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (inference-app ì´ë¦„ ê¸°ì¤€)
    - ssh $AWS_USER@$AWS_IP "docker stop inference-app || true"
    - ssh $AWS_USER@$AWS_IP "docker rm inference-app || true"
    
    # 4. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
    # -p 8080:8080 ë¶€ë¶„ì€ ì‹¤ì œ ì‚¬ìš© í¬íŠ¸ì— ë§ì¶° ìˆ˜ì •í•˜ì„¸ìš”.
    - ssh $AWS_USER@$AWS_IP "docker run -d --name inference-app --env-file ./ai.env -p 8000:8000 $DOCKER_IMAGE_FULL_NAME"    
    # 5. ê³µê°„ ì ˆì•½ì„ ìœ„í•´ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” êµ¬ë²„ì „ ì´ë¯¸ì§€ ì •ë¦¬ (ì„ íƒ ì‚¬í•­)
    - ssh $AWS_USER@$AWS_IP "docker image prune -f"
  extends: .ai-dev-rules
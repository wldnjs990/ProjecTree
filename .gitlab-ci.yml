stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_FULL_NAME: "$DOCKERHUB_USERNAME/$DOCKERHUB_REPO:$CI_COMMIT_SHORT_SHA"

.ai-dev-rules:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "ai-dev"'
    - if: '$CI_COMMIT_BRANCH == "ai-dev"'

build_push_dockerhub:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - echo "Moving to projectree-inference directory..."
    - cd projectree-inference
    - echo "Building Docker Hub image..."
    - docker build -t $DOCKER_IMAGE_FULL_NAME .
    - docker push $DOCKER_IMAGE_FULL_NAME
  extends: .ai-dev-rules

deploy_to_aws:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$AWS_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $AWS_IP >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to AWS..."
    - ssh $AWS_USER@$AWS_IP "echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin"
    - ssh $AWS_USER@$AWS_IP "docker pull $DOCKER_IMAGE_FULL_NAME"
    - ssh $AWS_USER@$AWS_IP "docker stop inference-app || true"
    - ssh $AWS_USER@$AWS_IP "docker rm inference-app || true"
    - ssh $AWS_USER@$AWS_IP "docker run -d --name inference-app --env-file ./ai.env -p 8000:8000 $DOCKER_IMAGE_FULL_NAME"
    - ssh $AWS_USER@$AWS_IP "docker image prune -f"
  extends: .ai-dev-rules
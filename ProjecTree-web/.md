종합 핸드오프 프롬프트 (프론트엔드 + CRDT 노드서버 + Spring 서버)
프로젝트 개요
ProjecTree - 프로젝트 구조를 트리 형태로 시각화하고, AI가 다음 노드와 기술스택을 추천해주는 협업 도구. React + ReactFlow 프론트엔드, Y.js CRDT 노드서버, Spring 백엔드 아키텍처.

1. 프론트엔드 변경사항
   1-1. Preview 노드 생명주기 완전 리팩토링
   핵심 변경: Preview 노드(미리보기 노드)의 생성→pending→완료→정리 사이클을 CRDT 옵저버 기반으로 전면 변경

nodeDetailCrdtService.ts (src/features/workspace-core/services/)

nodeCreatingPendingHandler (라인 180-211): nodeCreatingPending Y.Map 옵저버

pending=false 수신 시: previewNodes Y.Map에서 해당 preview 노드 삭제 + nodeCreatingPending 엔트리 삭제
현재 클라이언트가 해당 preview를 보고 있으면 exitCandidatePreview() 호출하여 UI 복귀
pending=true 수신 시: 현재 클라이언트가 보고 있으면 setIsCreatingNode(true) 설정
이전 방식: NodeDetailSidebar의 wasCreatingRef useEffect가 cleanup 담당 → 제거됨
새 방식: CRDT 옵저버가 직접 cleanup → 뒤로가기 후에도 정상 동작
clearNonPendingPreviewNodes(ownerId) (라인 602-627): 새 메서드

새로고침/재연결 시 호출
nodeCreatingPending이 true인 preview 노드는 건너뜀 (서버가 아직 처리 중)
non-pending이고 lockedBy === ownerId인 preview 노드만 삭제
이전 방식: previewNodesCrdtService.clearPreviewNodesByOwner() → 모든 preview 노드 삭제 (pending 포함)
updateCandidates(nodeId, newCandidates) (라인 520-537): 후보 병합 방식 변경

기존 후보에 새 후보를 append (덮어쓰기 아님)
기존: set(nodeId, newCandidates) → 새것: set(nodeId, [...current, ...new])
addTechRecommendation(nodeId, tech) (라인 558-574): 개별 기술 추가 메서드

커스텀 기술스택 추가용 (기존 목록에 1개 append)
Y.Map 구조 (plain array로 변경됨):

nodeTechRecommendations: Y.Map<TechRecommendation[]> (이전: Y.Map<Y.Array>)
nodeCandidates: Y.Map<Candidate[]> (이전: Y.Map<Y.Array>)
노드서버에서도 동일하게 plain array로 set/get 해야 함
useNodeDetailCrdtObservers.ts (src/features/workspace-core/hooks/)

// 새로고침/재연결 시 이전 세션 preview 노드 정리
// pending 중인 preview 노드는 보존 (nodeCreatingPendingHandler가 완료 시 자동 정리)
if (currentUserId) {
nodeDetailCrdtService.clearNonPendingPreviewNodes(currentUserId);
}
NodeDetailSidebar.tsx (src/features/workspace-node-detail/components/)

handleExitPreview: 현재 보고 있는 non-pending preview 노드 1개만 제거

if (currentPreviewNodeId && !isCreatingNode) {
previewNodesCrdtService.removePreviewNode(currentPreviewNodeId);
}
exitCandidatePreview();
이전: clearPreviewNodesByOwner(currentUserId) → 내 모든 preview 제거
새것: removePreviewNode(currentPreviewNodeId) → 현재 것만 제거, pending이면 건너뜀
제거된 코드: wasCreatingRef (useRef), 관련 useEffect, useUser import, currentUserId 변수

AINodeCandidateSection.tsx (src/features/workspace-node-detail/components/)

후보 카드 disabled/selected 로직:

const isLocked = lockedCandidateIds.has(node.id); // preview 노드 존재 = pending 중
const isSelected = selectedCandidateIds.includes(node.id); // candidate.selected = 이미 생성됨
<SubNodeCard
isSelected={isSelected || isLocked} // 체크 아이콘 표시
disabled={isLocked || isSelected} // 클릭 불가
/>
lockedCandidateIds: previewNodes Y.Map에서 preview-{candidateId} 패턴으로 추출
다른 사용자가 생성 중인 후보도 disable 표시됨 (CRDT로 preview 노드 공유)
CandidateNodeContainer.tsx / CustomNodeContainer.tsx

뒤로가기 버튼에서 disabled={isCreating} 제거
이유: pending 중 뒤로가기 허용, preview 노드는 CRDT 옵저버가 관리
1-2. 커스텀 기술스택 추가 기능
NodeDetailContainer.tsx (라인 226-245)

const handleAddCustomTech = async (techVocaId: number) => {
nodeDetailCrdtService.setTechsPending(selectedNodeId, true);
try {
await postCustomNodeTechRecommendation(Number(selectedNodeId), {
workspaceId, techVocaId,
});
toast.success('기술스택이 추가되었습니다.');
} catch (error) {
nodeDetailCrdtService.setTechsPending(selectedNodeId, false);
}
}; 2. CRDT 노드서버 변경사항 (필요)
2-1. Y.Map 데이터 형식 변경 (중요!)
이전: nodeTechRecommendations과 nodeCandidates에 Y.Array 사용
이후: plain JavaScript array로 Y.Map.set(key, array) 호출

노드서버에서 Spring 응답을 받아 CRDT에 반영할 때:

// 기술스택 추천 결과 반영 (전체 교체)
const yNodeTechRecommendations = yDoc.getMap('nodeTechRecommendations');
yNodeTechRecommendations.set(nodeId, techArray); // plain array 직접 set
yDoc.getMap('nodeTechsPending').set(nodeId, false);

// 후보 노드 결과 반영 (기존에 병합)
const yNodeCandidates = yDoc.getMap('nodeCandidates');
const existing = yNodeCandidates.get(nodeId) || [];
yNodeCandidates.set(nodeId, [...existing, ...newCandidates]); // 기존 + 새 것 병합
yDoc.getMap('nodeCandidatesPending').set(nodeId, false);
2-2. 노드 생성 완료 시 처리
Spring에서 노드 생성 성공 응답을 받으면:

// 1. 실제 노드를 nodes Y.Map에 추가
const yNodes = yDoc.getMap('nodes');
yNodes.set(newNodeId, newNodeData);

// 2. nodeCreatingPending을 false로 설정
// → 클라이언트의 nodeCreatingPendingHandler가 자동으로:
// - previewNodes에서 해당 preview 삭제
// - nodeCreatingPending 엔트리 삭제  
// - UI 상태 복귀
const yNodeCreatingPending = yDoc.getMap('nodeCreatingPending');
yNodeCreatingPending.set(previewNodeId, false);
주의: 클라이언트에서도 setNodeCreatingPending(previewNodeId, false)를 호출하므로, 노드서버에서 하지 않으면 클라이언트가 직접 처리합니다. 하지만 다른 클라이언트에게 브로드캐스트하려면 노드서버에서 처리하는 것이 이상적입니다.

2-3. 커스텀 기술스택 추가 처리
Spring에서 커스텀 기술 추가 성공 응답을 받으면:

// 기존 배열에 새 기술 1개 append
const yNodeTechRecommendations = yDoc.getMap('nodeTechRecommendations');
const existing = yNodeTechRecommendations.get(nodeId) || [];
yNodeTechRecommendations.set(nodeId, [...existing, newTech]);
yDoc.getMap('nodeTechsPending').set(nodeId, false); 3. Spring 서버 변경사항
3-1. 커스텀 기술스택 추가 API

POST /nodes/{nodeId}/tech-stack
Body: { workspaceId: number, techVocaId: number }
techVocaId로 기술 어휘 조회
해당 노드에 기술스택 추천 레코드 추가
응답을 CRDT 노드서버로 전달 (기존 기술 추천 응답과 동일 형식)
3-2. 노드 생성 API (기존)

POST /nodes (후보 노드 생성)
POST /nodes/custom (커스텀 노드 생성)
응답 시 CRDT 노드서버에게 노드 생성 완료 알림
노드서버가 nodeCreatingPending false 처리 4. Y.Map 구조 요약
Y.Map 이름 Key Value 용도
nodes nodeId (string) Y.Map<YNodeValue> ReactFlow 노드 데이터
previewNodes previewNodeId Y.Map<YNodeValue> 미리보기 노드 (임시)
nodeDetails nodeId Y.Map<YNodeDetailValue> 편집 중인 노드 상세
confirmedNodeData nodeId ConfirmedNodeData 확정된 노드 데이터
nodeCandidates nodeId Candidate[] (plain array) AI 추천 후보 노드
nodeTechRecommendations nodeId TechRecommendation[] (plain array) AI 추천 기술스택
nodeTechComparisons nodeId string 기술 비교 텍스트
nodeCandidatesPending nodeId boolean 후보 생성 pending
nodeTechsPending nodeId boolean 기술 추천 pending
nodeCreatingPending previewNodeId boolean 노드 생성 pending 5. Preview 노드 생명주기 흐름도

[사용자 A: 후보 선택]
→ previewNodesCrdtService.addPreviewNode({id: "preview-123", ...})
→ enterCandidatePreview(candidate, position)
→ CandidateNodeContainer 표시

[사용자 A: 확정 버튼 클릭]
→ nodeDetailCrdtService.setNodeCreatingPending("preview-123", true)
→ Y.Map('nodeCreatingPending').set("preview-123", true) → 브로드캐스트
→ 모든 클라이언트: lockedCandidateIds에 123 추가 → 해당 후보 disabled + 체크 표시
→ postCreateNode() API 호출

[사용자 A: 뒤로가기 (pending 중)]
→ handleExitPreview(): isCreatingNode=true이므로 preview 노드 제거 안 함
→ exitCandidatePreview(): UI만 NodeDetailContainer로 복귀
→ isCreatingNode=false (store reset), 하지만 preview 노드는 CRDT에 남아있음

[Spring 서버: 노드 생성 완료]
→ 노드서버: nodes Y.Map에 실제 노드 추가
→ 노드서버 또는 클라이언트: nodeCreatingPending.set("preview-123", false)

[nodeCreatingPendingHandler 옵저버 실행 (모든 클라이언트)]
→ pending=false 수신
→ previewNodes.delete("preview-123") ← preview 노드 제거
→ nodeCreatingPending.delete("preview-123") ← pending 엔트리 정리
→ 현재 클라이언트가 보고 있었다면 exitCandidatePreview()

[새로고침 시]
→ useNodeDetailCrdtObservers: clearNonPendingPreviewNodes(userId)
→ pending=true인 preview 노드는 건너뜀 (서버 처리 대기)
→ non-pending preview 노드만 정리 6. 알려진 제한사항 / 향후 작업
새로고침 후 pending 애니메이션: 새로고침 시 isCreatingNode Zustand 상태가 초기화되어 pending 중인 preview 노드의 로딩 애니메이션이 표시되지 않음. loadExistingData에서 nodeCreatingPending 복원 로직 추가 필요.

커스텀 기술스택 추가 UI: CustomTechAddDialog 컴포넌트가 아직 구현되지 않음. 계획 파일(hidden-cooking-tiger.md) 참조.

handleConfirmCreate 주석 업데이트 필요: 라인 175-176의 wasCreatingRef 관련 주석이 남아있음.
